#!/bin/bash

mkdir test_$$


log="/tmp/allas_test_$$"

echo "aaa" > test_$$/a.txt
echo "bbb" > test_$$/b.txt
echo "ccc" > test_$$/c.txt

test_bucket="allastest$$"

#a-put

object=$(a-put -b $test_bucket test_$$ -s 2> $log | tail -1 | tr -d "\n")
if [[ $object == "$test_bucket/test_$$.tar" ]] ; then
  echo "a-put OK"
else
  echo "a-put FAILED"
  echo $object
  echo
  cat $log
  rm -f $log
 # exit 1
fi
 
#a-list
t1=$(a-list $test_bucket | tr -d "\n" )
if [[ $t1 == "$test_bucket/test_$$.tar" ]]; then
  echo "a-list OK"
else
  echo "a-list FAILED"
  echo "a-list  $test_bucket"
  a-list $test_bucket
  exit
fi

#a-info

if [[ $(a-info $object | grep -c "test_") -eq 8 ]]; then
  echo "a-info OK"
else
  echo "a-info $object"
  exit
fi

rm -rf test_$$

#a-get
a-get $object > $log
if [[ $(ls  test_$$ | grep -c .txt) -eq 3 ]]; then
  echo "a-get OK"
else
    echo "a-get FAILED  "
    echo
    cat $log
  rm -f $log
fi

echo "a-delete -f  $object" >> $log
a-delete -f  $object >> $log

echo "" >> $log
echo "a-delete --rmb $test_bucket -f" >> $log 
a-delete --rmb $test_bucket -f >> $log

rm -rf test_$$

echo "a-list $test_bucket" >> $log

a=$(a-list $test_bucket 2>&1 | head -1 | awk '{print $(NF-1)" "$NF}' )
if [[ $a == "not found" ]]; then
   echo "a-delete OK"
else
    echo "a-delete FAILED"
    echo $a
    echo
    cat $log
    rm $log
fi
